<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport Pickup Manager</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Lucide React Icons (inline)
        const Plane = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>
        );
        const Users = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        );
        const Car = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/><circle cx="7" cy="17" r="2"/><path d="M9 17h6"/><circle cx="17" cy="17" r="2"/></svg>
        );
        const Clock = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        );
        const AlertCircle = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        );
        const CheckCircle = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const XCircle = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
        );
        const Plus = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        );
        const Search = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        );
        const Edit2 = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
        );
        const Trash2 = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
        );
        const User = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
        );
        const Phone = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
        );
        const Save = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        );
        const Upload = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        );
        const Download = (props) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        );

        // Comprehensive list of airlines with IATA codes
        const AIRLINES = [
          { code: 'AA', name: 'American Airlines' },
          { code: 'DL', name: 'Delta Air Lines' },
          { code: 'UA', name: 'United Airlines' },
          { code: 'WN', name: 'Southwest Airlines' },
          { code: 'B6', name: 'JetBlue Airways' },
          { code: 'AS', name: 'Alaska Airlines' },
          { code: 'F9', name: 'Frontier Airlines' },
          { code: 'NK', name: 'Spirit Airlines' },
          { code: 'G4', name: 'Allegiant Air' },
          { code: 'SY', name: 'Sun Country Airlines' },
          { code: 'BA', name: 'British Airways' },
          { code: 'LH', name: 'Lufthansa' },
          { code: 'AF', name: 'Air France' },
          { code: 'KL', name: 'KLM Royal Dutch Airlines' },
          { code: 'EK', name: 'Emirates' },
          { code: 'QR', name: 'Qatar Airways' },
          { code: 'SQ', name: 'Singapore Airlines' },
          { code: 'AC', name: 'Air Canada' },
          { code: 'WS', name: 'WestJet' },
          { code: 'AV', name: 'Avianca' },
          { code: 'AM', name: 'AeromÃ©xico' },
          { code: 'LA', name: 'LATAM Airlines' },
          { code: 'CM', name: 'Copa Airlines' },
          { code: 'IB', name: 'Iberia' },
          { code: 'AY', name: 'Finnair' },
          { code: 'SK', name: 'Scandinavian Airlines (SAS)' },
          { code: 'LX', name: 'Swiss International Air Lines' },
          { code: 'OS', name: 'Austrian Airlines' },
          { code: 'TP', name: 'TAP Air Portugal' },
          { code: 'AZ', name: 'ITA Airways' },
          { code: 'TK', name: 'Turkish Airlines' },
          { code: 'EY', name: 'Etihad Airways' },
          { code: 'SV', name: 'Saudia' },
          { code: 'MS', name: 'EgyptAir' },
          { code: 'ET', name: 'Ethiopian Airlines' },
          { code: 'KE', name: 'Korean Air' },
          { code: 'OZ', name: 'Asiana Airlines' },
          { code: 'NH', name: 'All Nippon Airways (ANA)' },
          { code: 'JL', name: 'Japan Airlines' },
          { code: 'CX', name: 'Cathay Pacific' },
          { code: 'CA', name: 'Air China' },
          { code: 'CZ', name: 'China Southern Airlines' },
          { code: 'MU', name: 'China Eastern Airlines' },
          { code: 'QF', name: 'Qantas' },
          { code: 'VA', name: 'Virgin Australia' },
          { code: 'NZ', name: 'Air New Zealand' },
          { code: 'AI', name: 'Air India' },
          { code: 'BR', name: 'EVA Air' },
          { code: 'TG', name: 'Thai Airways' },
          { code: 'MH', name: 'Malaysia Airlines' },
          { code: 'GA', name: 'Garuda Indonesia' },
          { code: 'PR', name: 'Philippine Airlines' },
          { code: 'VN', name: 'Vietnam Airlines' },
          { code: 'SA', name: 'South African Airways' },
          { code: 'VS', name: 'Virgin Atlantic' },
          { code: 'EI', name: 'Aer Lingus' },
          { code: 'FI', name: 'Icelandair' },
          { code: 'WY', name: 'Oman Air' },
        ].sort((a, b) => a.name.localeCompare(b.name));

        const API_URL = 'https://airport-backend-production-89e9.up.railway.app';

        function AirportPickupManager() {
          const [guests, setGuests] = useState([]);
          const [cars, setCars] = useState([]);
          const [nextCarId, setNextCarId] = useState(1);
          const [searchTerm, setSearchTerm] = useState('');
          const [filterStatus, setFilterStatus] = useState('all');
          const [showAddGuest, setShowAddGuest] = useState(false);
          const [showBulkUpload, setShowBulkUpload] = useState(false);
          const [editingGuest, setEditingGuest] = useState(null);
          const [editingCar, setEditingCar] = useState(null);
          const [isRefreshing, setIsRefreshing] = useState(false);
          
          const [newGuest, setNewGuest] = useState({ 
            name: '', 
            flight: '', 
            airline: '', 
            airlineName: '',
            origin: '', 
            eta: '' 
          });

          // Load data from backend on mount
          useEffect(() => {
            testBackendConnection();
            loadGuestsFromBackend();
            loadCarsFromBackend();
          }, []);

          const testBackendConnection = async () => {
            try {
              console.log('Testing backend connection to:', API_URL);
              const response = await fetch(`${API_URL}/`);
              if (response.ok) {
                const data = await response.json();
                console.log('Backend connection successful:', data);
              } else {
                console.error('Backend connection failed with status:', response.status);
              }
            } catch (error) {
              console.error('Cannot connect to backend:', error);
              alert(`âš ï¸ Warning: Cannot connect to backend at ${API_URL}. Please check if backend is running.`);
            }
          };

          const loadGuestsFromBackend = async () => {
            try {
              const response = await fetch(`${API_URL}/api/guests`);
              if (response.ok) {
                const data = await response.json();
                setGuests(data);
              }
            } catch (error) {
              console.error('Error loading guests:', error);
            }
          };

          const loadCarsFromBackend = async () => {
            try {
              const response = await fetch(`${API_URL}/api/cars`);
              if (response.ok) {
                const data = await response.json();
                setCars(data);
                if (data.length > 0) {
                  const maxId = Math.max(...data.map(c => c.id));
                  setNextCarId(maxId + 1);
                }
              }
            } catch (error) {
              console.error('Error loading cars:', error);
            }
          };

          // Call AviationStack API via backend
          const fetchFlightStatus = async (flight, airline) => {
            try {
              const response = await fetch(`${API_URL}/api/flight-status?flight=${flight}&airline=${airline}`);
              if (response.ok) {
                const data = await response.json();
                return data.status || 'Unknown';
              }
            } catch (error) {
              console.error('Error fetching flight status:', error);
            }
            return null;
          };

          // Refresh all flight statuses
          const refreshFlightStatuses = async () => {
            setIsRefreshing(true);
            try {
              const updatedGuests = await Promise.all(
                guests.map(async (guest) => {
                  const status = await fetchFlightStatus(guest.flight, guest.airline);
                  return status ? { ...guest, status } : guest;
                })
              );
              setGuests(updatedGuests);
              
              // Update all guests in backend
              for (const guest of updatedGuests) {
                await fetch(`${API_URL}/api/guests/${guest.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(guest)
                });
              }
            } catch (error) {
              console.error('Error refreshing flight statuses:', error);
            }
            setIsRefreshing(false);
          };

          // Auto-refresh every 5 minutes
          useEffect(() => {
            if (guests.length > 0) {
              const interval = setInterval(refreshFlightStatuses, 300000);
              return () => clearInterval(interval);
            }
          }, [guests]);

          const handleAddGuest = async () => {
            // Validation
            if (!newGuest.name) {
              alert('Please enter guest name');
              return;
            }
            if (!newGuest.flight) {
              alert('Please enter flight number');
              return;
            }
            if (!newGuest.airline) {
              alert('Please select an airline');
              return;
            }
            if (!newGuest.origin) {
              alert('Please enter origin airport');
              return;
            }
            if (!newGuest.eta) {
              alert('Please enter arrival date and time (both date AND time are required)');
              return;
            }

            console.log('Adding guest with data:', newGuest);

            const airlineInfo = AIRLINES.find(a => a.code === newGuest.airline);
            const guest = {
              name: newGuest.name.trim(),
              flight: newGuest.flight.trim(),
              airline: newGuest.airline.trim(),
              airlineName: airlineInfo ? airlineInfo.name : newGuest.airline,
              origin: newGuest.origin.trim(),
              eta: newGuest.eta,
              status: 'On Time',
              carAssigned: null
            };

            console.log('Sending to backend:', guest);
            console.log('Backend URL:', API_URL);

            try {
              const response = await fetch(`${API_URL}/api/guests`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(guest)
              });
              
              console.log('Response status:', response.status);
              
              if (response.ok) {
                const savedGuest = await response.json();
                console.log('Guest saved successfully:', savedGuest);
                setGuests([...guests, savedGuest]);
                setNewGuest({ name: '', flight: '', airline: '', airlineName: '', origin: '', eta: '' });
                setShowAddGuest(false);
                alert('Guest added successfully!');
              } else {
                const errorText = await response.text();
                console.error('Backend error:', errorText);
                alert(`Error adding guest: ${errorText || 'Unknown error'}`);
              }
            } catch (error) {
              console.error('Network error adding guest:', error);
              alert(`Network error: ${error.message}. Is the backend running?`);
            }
          };

          const handleEditGuest = (guest) => {
            setEditingGuest({...guest});
          };

          const handleUpdateGuest = async () => {
            if (editingGuest) {
              const airlineInfo = AIRLINES.find(a => a.code === editingGuest.airline);
              const updatedGuest = {
                ...editingGuest,
                airlineName: airlineInfo ? airlineInfo.name : editingGuest.airline,
              };

              try {
                const response = await fetch(`${API_URL}/api/guests/${editingGuest.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(updatedGuest)
                });

                if (response.ok) {
                  setGuests(guests.map(g => g.id === editingGuest.id ? updatedGuest : g));
                  setEditingGuest(null);
                }
              } catch (error) {
                console.error('Error updating guest:', error);
              }
            }
          };

          const handleDeleteGuest = async (id) => {
            if (confirm('Are you sure you want to delete this guest?')) {
              try {
                const response = await fetch(`${API_URL}/api/guests/${id}`, {
                  method: 'DELETE'
                });

                if (response.ok) {
                  setGuests(guests.filter(g => g.id !== id));
                  setCars(cars.map(car => ({
                    ...car,
                    passengers: car.passengers.filter(pid => pid !== id)
                  })));
                }
              } catch (error) {
                console.error('Error deleting guest:', error);
              }
            }
          };

          const handleEditCar = (car) => {
            setEditingCar({...car});
          };

          const handleUpdateCar = async () => {
            if (editingCar) {
              try {
                const response = await fetch(`${API_URL}/api/cars/${editingCar.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(editingCar)
                });

                if (response.ok) {
                  setCars(cars.map(c => c.id === editingCar.id ? editingCar : c));
                  setEditingCar(null);
                }
              } catch (error) {
                console.error('Error updating car:', error);
              }
            }
          };

          const handleReassignCar = async (guestId, newCarId) => {
            const updatedCars = cars.map(car => ({
              ...car,
              passengers: car.passengers.filter(pid => pid !== guestId)
            }));

            if (newCarId) {
              const carIndex = updatedCars.findIndex(c => c.id === parseInt(newCarId));
              if (carIndex !== -1) {
                updatedCars[carIndex].passengers.push(guestId);
              }
            }

            setCars(updatedCars);
            
            const updatedGuests = guests.map(g => 
              g.id === guestId ? { ...g, carAssigned: newCarId ? parseInt(newCarId) : null } : g
            );
            setGuests(updatedGuests);

            // Update backend
            try {
              await fetch(`${API_URL}/api/guests/${guestId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedGuests.find(g => g.id === guestId))
              });

              for (const car of updatedCars) {
                await fetch(`${API_URL}/api/cars/${car.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(car)
                });
              }
            } catch (error) {
              console.error('Error reassigning car:', error);
            }
          };

          const autoAssignCars = async () => {
            const flightGroups = {};
            guests.forEach(guest => {
              const key = `${guest.flight}-${guest.eta}`;
              if (!flightGroups[key]) flightGroups[key] = [];
              flightGroups[key].push(guest);
            });

            let newCars = [];
            let carId = 1;

            Object.values(flightGroups).forEach(group => {
              let tempGroup = [...group];
              while (tempGroup.length > 0) {
                const carPassengers = tempGroup.splice(0, 5);
                newCars.push({
                  id: carId++,
                  passengers: carPassengers.map(g => g.id),
                  driverName: '',
                  driverPhone: '',
                  notes: ''
                });
              }
            });

            setCars(newCars);
            setNextCarId(carId);
            
            const updatedGuests = guests.map(guest => {
              const car = newCars.find(c => c.passengers.includes(guest.id));
              return { ...guest, carAssigned: car ? car.id : null };
            });
            setGuests(updatedGuests);

            // Save to backend
            try {
              // Delete old cars
              await fetch(`${API_URL}/api/cars`, { method: 'DELETE' });
              
              // Create new cars
              for (const car of newCars) {
                await fetch(`${API_URL}/api/cars`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(car)
                });
              }

              // Update guests
              for (const guest of updatedGuests) {
                await fetch(`${API_URL}/api/guests/${guest.id}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(guest)
                });
              }
            } catch (error) {
              console.error('Error auto-assigning cars:', error);
            }
          };

          const addNewCar = async () => {
            const newCar = {
              id: nextCarId,
              passengers: [],
              driverName: '',
              driverPhone: '',
              notes: ''
            };

            try {
              const response = await fetch(`${API_URL}/api/cars`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newCar)
              });

              if (response.ok) {
                setCars([...cars, newCar]);
                setNextCarId(nextCarId + 1);
              }
            } catch (error) {
              console.error('Error adding car:', error);
            }
          };

          // Bulk Upload
          const handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const fileExtension = file.name.split('.').pop().toLowerCase();

            if (fileExtension === 'csv') {
              Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => processUploadedData(results.data)
              });
            } else if (['xlsx', 'xls'].includes(fileExtension)) {
              const reader = new FileReader();
              reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                processUploadedData(jsonData);
              };
              reader.readAsArrayBuffer(file);
            }
          };

          const processUploadedData = async (data) => {
            const newGuests = data.map((row) => {
              const airlineCode = (row.airline || '').trim().toUpperCase();
              const airlineInfo = AIRLINES.find(a => a.code === airlineCode);
              
              return {
                name: (row.name || '').trim(),
                flight: (row.flight || '').trim().toUpperCase(),
                airline: airlineCode,
                airlineName: airlineInfo ? airlineInfo.name : airlineCode,
                origin: (row.origin || '').trim().toLowerCase(),
                eta: row.eta || '',
                status: 'On Time',
                carAssigned: null
              };
            }).filter(g => g.name && g.flight && g.eta);

            try {
              const savedGuests = [];
              for (const guest of newGuests) {
                const response = await fetch(`${API_URL}/api/guests`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(guest)
                });
                
                if (response.ok) {
                  const savedGuest = await response.json();
                  savedGuests.push(savedGuest);
                }
              }

              setGuests([...guests, ...savedGuests]);
              setShowBulkUpload(false);
              alert(`Successfully uploaded ${savedGuests.length} guests`);
            } catch (error) {
              console.error('Error uploading guests:', error);
            }
          };

          const downloadTemplate = () => {
            const template = [
              { name: 'John Doe', flight: 'AA123', airline: 'AA', origin: 'JFK', eta: '2025-10-08T14:30' },
              { name: 'Jane Smith', flight: 'DL456', airline: 'DL', origin: 'LAX', eta: '2025-10-08T15:45' }
            ];

            const ws = XLSX.utils.json_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Guests');
            XLSX.writeFile(wb, 'guest_template.xlsx');
          };

          const filteredGuests = guests.filter(guest => {
            const matchesSearch = guest.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                 guest.flight.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesFilter = filterStatus === 'all' || guest.status === filterStatus;
            return matchesSearch && matchesFilter;
          });

          const groupedByFlight = {};
          filteredGuests.forEach(guest => {
            const key = `${guest.flight}-${guest.eta}`;
            if (!groupedByFlight[key]) {
              groupedByFlight[key] = {
                flight: guest.flight,
                airline: guest.airlineName || guest.airline,
                origin: guest.origin,
                eta: guest.eta,
                status: guest.status,
                guests: []
              };
            }
            groupedByFlight[key].guests.push(guest);
          });

          const stats = {
            total: guests.length,
            onTime: guests.filter(g => g.status === 'On Time').length,
            delayed: guests.filter(g => g.status === 'Delayed').length,
            cancelled: guests.filter(g => g.status === 'Cancelled').length,
            landed: guests.filter(g => g.status === 'Landed').length,
            cars: cars.length
          };

          const getStatusIcon = (status) => {
            switch(status) {
              case 'On Time': return <CheckCircle className="w-4 h-4 text-green-600" />;
              case 'Delayed': return <Clock className="w-4 h-4 text-yellow-600" />;
              case 'Cancelled': return <XCircle className="w-4 h-4 text-red-600" />;
              case 'Landed': return <Plane className="w-4 h-4 text-blue-600" />;
              default: return <AlertCircle className="w-4 h-4 text-gray-600" />;
            }
          };

          const getStatusColor = (status) => {
            switch(status) {
              case 'On Time': return 'bg-green-50 border-green-200';
              case 'Delayed': return 'bg-yellow-50 border-yellow-200';
              case 'Cancelled': return 'bg-red-50 border-red-200';
              case 'Landed': return 'bg-blue-50 border-blue-200';
              default: return 'bg-gray-50 border-gray-200';
            }
          };

          return (
            <div className="min-h-screen bg-gray-50 p-6">
              <div className="max-w-7xl mx-auto">
                <div className="mb-6">
                  <h1 className="text-3xl font-bold text-gray-900">Airport Pickup Manager</h1>
                  <p className="text-gray-600">Real-time flight tracking powered by AviationStack API</p>
                  <p className="text-sm text-gray-500">Last updated: {new Date().toLocaleTimeString()}</p>
                </div>

                {/* Stats Cards */}
                <div className="grid grid-cols-2 md:grid-cols-6 gap-4 mb-6">
                  <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Total</p>
                        <p className="text-2xl font-bold">{stats.total}</p>
                      </div>
                      <Users className="w-8 h-8 text-blue-500" />
                    </div>
                  </div>
                  
                  <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">On Time</p>
                        <p className="text-2xl font-bold">{stats.onTime}</p>
                      </div>
                      <CheckCircle className="w-8 h-8 text-green-500" />
                    </div>
                  </div>
                  
                  <div className="bg-white p-4 rounded-lg shadow border-l-4 border-yellow-500">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Delayed</p>
                        <p className="text-2xl font-bold">{stats.delayed}</p>
                      </div>
                      <Clock className="w-8 h-8 text-yellow-500" />
                    </div>
                  </div>

                  <div className="bg-white p-4 rounded-lg shadow border-l-4 border-red-500">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Cancelled</p>
                        <p className="text-2xl font-bold">{stats.cancelled}</p>
                      </div>
                      <XCircle className="w-8 h-8 text-red-500" />
                    </div>
                  </div>

                  <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-600">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Landed</p>
                        <p className="text-2xl font-bold">{stats.landed}</p>
                      </div>
                      <Plane className="w-8 h-8 text-blue-600" />
                    </div>
                  </div>
                  
                  <div className="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Cars</p>
                        <p className="text-2xl font-bold">{stats.cars}</p>
                      </div>
                      <Car className="w-8 h-8 text-purple-500" />
                    </div>
                  </div>
                </div>

                {/* Controls */}
                <div className="bg-white p-4 rounded-lg shadow mb-6">
                  <div className="flex flex-wrap gap-3 items-center">
                    <div className="flex-1 min-w-[200px]">
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4" />
                        <input
                          type="text"
                          placeholder="Search by name or flight number..."
                          value={searchTerm}
                          onChange={(e) => setSearchTerm(e.target.value)}
                          className="w-full pl-10 pr-4 py-2 border rounded-lg"
                        />
                      </div>
                    </div>
                    
                    <select
                      value={filterStatus}
                      onChange={(e) => setFilterStatus(e.target.value)}
                      className="px-4 py-2 border rounded-lg"
                    >
                      <option value="all">All Statuses</option>
                      <option value="On Time">On Time</option>
                      <option value="Delayed">Delayed</option>
                      <option value="Cancelled">Cancelled</option>
                      <option value="Landed">Landed</option>
                    </select>

                    <button
                      onClick={() => setShowAddGuest(true)}
                      className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2"
                    >
                      <Plus className="w-4 h-4" /> Add Guest
                    </button>

                    <button
                      onClick={() => setShowBulkUpload(true)}
                      className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2"
                    >
                      <Upload className="w-4 h-4" /> Bulk Upload
                    </button>

                    <button
                      onClick={refreshFlightStatuses}
                      disabled={isRefreshing}
                      className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50"
                    >
                      {isRefreshing ? 'ðŸ”„ Refreshing...' : 'ðŸ”„ Refresh'}
                    </button>

                    <button
                      onClick={autoAssignCars}
                      className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700"
                    >
                      ðŸš— Auto Assign
                    </button>
                  </div>
                </div>

                {/* Modals and other JSX continues... */}
                {/* (Truncated for length - same structure continues with all modals and flight dashboard) */}
                
                {/* Bulk Upload Modal */}
                {showBulkUpload && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                      <h3 className="text-xl font-bold mb-4">Bulk Upload Guests</h3>
                      <div className="space-y-4">
                        <p className="text-sm text-gray-600">
                          Upload a CSV or Excel file with columns: name, flight, airline, origin, eta
                        </p>
                        
                        <button
                          onClick={downloadTemplate}
                          className="w-full px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 flex items-center justify-center gap-2"
                        >
                          <Download className="w-4 h-4" /> Download Template
                        </button>

                        <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                          <input
                            type="file"
                            accept=".csv,.xlsx,.xls"
                            onChange={handleFileUpload}
                            className="hidden"
                            id="file-upload"
                          />
                          <label
                            htmlFor="file-upload"
                            className="cursor-pointer flex flex-col items-center"
                          >
                            <Upload className="w-12 h-12 text-gray-400 mb-2" />
                            <span className="text-sm text-gray-600">
                              Click to upload CSV or Excel file
                            </span>
                          </label>
                        </div>
                      </div>
                      <div className="flex gap-3 mt-4">
                        <button
                          onClick={() => setShowBulkUpload(false)}
                          className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Add/Edit Guest Modal */}
                {(showAddGuest || editingGuest) && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                      <h3 className="text-xl font-bold mb-4">
                        {editingGuest ? 'Edit Guest' : 'Add New Guest'}
                      </h3>
                      <div className="space-y-3">
                        <input
                          type="text"
                          placeholder="Guest Name"
                          value={editingGuest ? editingGuest.name : newGuest.name}
                          onChange={(e) => editingGuest 
                            ? setEditingGuest({...editingGuest, name: e.target.value})
                            : setNewGuest({...newGuest, name: e.target.value})
                          }
                          className="w-full px-4 py-2 border rounded-lg"
                        />
                        <input
                          type="text"
                          placeholder="Flight Number (e.g., AA123)"
                          value={editingGuest ? editingGuest.flight : newGuest.flight}
                          onChange={(e) => editingGuest
                            ? setEditingGuest({...editingGuest, flight: e.target.value.toUpperCase()})
                            : setNewGuest({...newGuest, flight: e.target.value.toUpperCase()})
                          }
                          className="w-full px-4 py-2 border rounded-lg"
                        />
                        <select
                          value={editingGuest ? editingGuest.airline : newGuest.airline}
                          onChange={(e) => editingGuest
                            ? setEditingGuest({...editingGuest, airline: e.target.value})
                            : setNewGuest({...newGuest, airline: e.target.value})
                          }
                          className="w-full px-4 py-2 border rounded-lg"
                        >
                          <option value="">Select Airline</option>
                          {AIRLINES.map(airline => (
                            <option key={airline.code} value={airline.code}>
                              {airline.code} - {airline.name}
                            </option>
                          ))}
                        </select>
                        <input
                          type="text"
                          placeholder="Origin Airport (e.g., JFK)"
                          value={editingGuest ? editingGuest.origin : newGuest.origin}
                          onChange={(e) => editingGuest
                            ? setEditingGuest({...editingGuest, origin: e.target.value.toLowerCase()})
                            : setNewGuest({...newGuest, origin: e.target.value.toLowerCase()})
                          }
                          className="w-full px-4 py-2 border rounded-lg"
                        />
                        <input
                          type="datetime-local"
                          value={editingGuest ? editingGuest.eta : newGuest.eta}
                          onChange={(e) => editingGuest
                            ? setEditingGuest({...editingGuest, eta: e.target.value})
                            : setNewGuest({...newGuest, eta: e.target.value})
                          }
                          className="w-full px-4 py-2 border rounded-lg"
                        />
                        {editingGuest && (
                          <select
                            value={editingGuest.status}
                            onChange={(e) => setEditingGuest({...editingGuest, status: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg"
                          >
                            <option value="On Time">On Time</option>
                            <option value="Delayed">Delayed</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="Landed">Landed</option>
                          </select>
                        )}
                      </div>
                      <div className="flex gap-3 mt-4">
                        <button
                          onClick={editingGuest ? handleUpdateGuest : handleAddGuest}
                          className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                          {editingGuest ? 'Update' : 'Add'} Guest
                        </button>
                        <button
                          onClick={() => {
                            setShowAddGuest(false);
                            setEditingGuest(null);
                          }}
                          className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Flights Dashboard */}
                <div className="mb-6">
                  <h2 className="text-xl font-bold mb-3">Flights Dashboard</h2>
                  <div className="grid gap-3">
                    {Object.values(groupedByFlight).map((flight, idx) => (
                      <div key={idx} className={`p-4 rounded-lg border-2 ${getStatusColor(flight.status)}`}>
                        <div className="flex items-center justify-between mb-3">
                          <div className="flex items-center gap-3">
                            <Plane className="w-5 h-5" />
                            <div>
                              <div className="font-bold text-lg">{flight.flight}</div>
                              <div className="text-sm text-gray-600">
                                {flight.airline} â€¢ From {flight.origin.toUpperCase()}
                              </div>
                            </div>
                          </div>
                          <div className="text-right">
                            <div className="flex items-center gap-2 justify-end">
                              {getStatusIcon(flight.status)}
                              <span className="font-semibold">{flight.status}</span>
                            </div>
                            <div className="text-sm text-gray-600">
                              {new Date(flight.eta).toLocaleString()}
                            </div>
                          </div>
                          <div className="bg-white px-3 py-1 rounded-full">
                            <span className="font-bold">{flight.guests.length}</span> guests
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2">
                          {flight.guests.map(guest => (
                            <div key={guest.id} className="bg-white p-2 rounded border flex items-center justify-between">
                              <div className="flex-1 min-w-0">
                                <div className="font-medium truncate">{guest.name}</div>
                                <div className="text-xs text-gray-500">
                                  {guest.carAssigned ? `ðŸš— Car #${guest.carAssigned}` : 'No car'}
                                </div>
                              </div>
                              <div className="flex gap-1 ml-2">
                                <button
                                  onClick={() => handleEditGuest(guest)}
                                  className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                  title="Edit"
                                >
                                  <Edit2 className="w-4 h-4" />
                                </button>
                                <button
                                  onClick={() => handleDeleteGuest(guest.id)}
                                  className="p-1 text-red-600 hover:bg-red-50 rounded"
                                  title="Delete"
                                >
                                  <Trash2 className="w-4 h-4" />
                                </button>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Edit Car Modal */}
                {editingCar && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                      <h3 className="text-xl font-bold mb-4">Edit Car #{editingCar.id}</h3>
                      <div className="space-y-3">
                        <div>
                          <label className="block text-sm font-medium mb-1">Driver Name</label>
                          <input
                            type="text"
                            placeholder="Driver name"
                            value={editingCar.driverName}
                            onChange={(e) => setEditingCar({...editingCar, driverName: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Driver Phone</label>
                          <input
                            type="tel"
                            placeholder="Phone number"
                            value={editingCar.driverPhone}
                            onChange={(e) => setEditingCar({...editingCar, driverPhone: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg"
                          />
                        </div>
                        <div>
                          <label className="block text-sm font-medium mb-1">Notes</label>
                          <textarea
                            placeholder="Additional notes"
                            value={editingCar.notes}
                            onChange={(e) => setEditingCar({...editingCar, notes: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg"
                            rows="2"
                          />
                        </div>
                      </div>
                      <div className="flex gap-3 mt-4">
                        <button
                          onClick={handleUpdateCar}
                          className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2"
                        >
                          <Save className="w-4 h-4" /> Save
                        </button>
                        <button
                          onClick={() => setEditingCar(null)}
                          className="px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Car Assignments */}
                <div>
                  <div className="flex items-center justify-between mb-3">
                    <h2 className="text-xl font-bold">ðŸš— Car Assignments ({cars.length} vehicles)</h2>
                    <button
                      onClick={addNewCar}
                      className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 flex items-center gap-2"
                    >
                      <Plus className="w-4 h-4" /> Add Car
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {cars.map(car => {
                      const carGuests = guests.filter(g => car.passengers.includes(g.id));
                      const flightStatus = carGuests[0]?.status || 'Unknown';
                      
                      return (
                        <div key={car.id} className={`p-4 rounded-lg border-2 ${getStatusColor(flightStatus)}`}>
                          <div className="flex items-center justify-between mb-3">
                            <div className="flex items-center gap-2">
                              <Car className="w-5 h-5" />
                              <span className="font-bold">Car #{car.id}</span>
                              <span className={`text-xs px-2 py-1 rounded ${
                                car.passengers.length === 5 ? 'bg-green-100 text-green-800' : 'bg-gray-100'
                              }`}>
                                {car.passengers.length}/5
                              </span>
                            </div>
                            <button
                              onClick={() => handleEditCar(car)}
                              className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                              title="Edit car details"
                            >
                              <Edit2 className="w-4 h-4" />
                            </button>
                          </div>

                          {(car.driverName || car.driverPhone) && (
                            <div className="bg-white p-2 rounded mb-2 text-sm">
                              {car.driverName && (
                                <div className="flex items-center gap-2">
                                  <User className="w-3 h-3" />
                                  <span>{car.driverName}</span>
                                </div>
                              )}
                              {car.driverPhone && (
                                <div className="flex items-center gap-2">
                                  <Phone className="w-3 h-3" />
                                  <span>{car.driverPhone}</span>
                                </div>
                              )}
                            </div>
                          )}

                          {carGuests.length > 0 && (
                            <div className="mb-2">
                              <div className="text-xs font-semibold text-gray-600 mb-1">
                                {carGuests[0].flight} â€¢ {new Date(carGuests[0].eta).toLocaleTimeString()}
                              </div>
                            </div>
                          )}
                          
                          <div className="space-y-1">
                            {carGuests.map(guest => (
                              <div key={guest.id} className="bg-white p-2 rounded text-sm flex items-center justify-between">
                                <span className="truncate">{guest.name}</span>
                                <select
                                  value={guest.carAssigned || ''}
                                  onChange={(e) => handleReassignCar(guest.id, e.target.value)}
                                  className="ml-2 text-xs border rounded px-1 py-0.5"
                                  title="Reassign to different car"
                                >
                                  <option value="">Unassigned</option>
                                  {cars.map(c => (
                                    <option key={c.id} value={c.id}>Car #{c.id}</option>
                                  ))}
                                </select>
                              </div>
                            ))}
                          </div>
                          
                          {car.passengers.length === 0 && (
                            <div className="text-center text-gray-400 text-sm py-2">
                              No passengers assigned
                            </div>
                          )}
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<AirportPickupManager />, document.getElementById('root'));
    </script>
</body>
</html>
