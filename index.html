<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport Pickup Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        const { Users, CheckCircle, XCircle, Clock, Plane, Car, RefreshCw, Upload, Plus, Shuffle } = lucide;

        function AirportPickupManager() {
          const API_URL = 'https://airport-backend-production-89e9.up.railway.app';
          
          const [guests, setGuests] = useState([]);
          const [loading, setLoading] = useState(false);
          const [lastUpdated, setLastUpdated] = useState(new Date().toLocaleTimeString());
          const [searchTerm, setSearchTerm] = useState('');
          const [statusFilter, setStatusFilter] = useState('all');
          const [showAddForm, setShowAddForm] = useState(false);
          const [editingGuest, setEditingGuest] = useState(null);
          
          const [newGuest, setNewGuest] = useState({
            name: '',
            phone: '',
            flight: '',
            airline: '',
            origin: '',
            destination: '',
            date: '',
            time: ''
          });

          const airlines = [
            { code: 'AA', name: 'American Airlines' },
            { code: 'DL', name: 'Delta Air Lines' },
            { code: 'UA', name: 'United Airlines' },
            { code: 'WN', name: 'Southwest Airlines' },
            { code: 'B6', name: 'JetBlue Airways' },
            { code: 'AS', name: 'Alaska Airlines' },
            { code: 'NK', name: 'Spirit Airlines' },
            { code: 'F9', name: 'Frontier Airlines' }
          ];

          const fetchGuests = async () => {
            setLoading(true);
            try {
              const response = await fetch(`${API_URL}/api/guests`);
              const data = await response.json();
              setGuests(data);
              setLastUpdated(new Date().toLocaleTimeString());
            } catch (error) {
              console.error('Error fetching guests:', error);
            }
            setLoading(false);
          };

          const addGuest = async () => {
            if (!newGuest.name || !newGuest.flight) return;
            
            try {
              const response = await fetch(`${API_URL}/api/guests`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  ...newGuest,
                  eta: `${newGuest.date}T${newGuest.time}:00`
                })
              });
              
              if (response.ok) {
                setNewGuest({ name: '', phone: '', flight: '', airline: '', origin: '', destination: '', date: '', time: '' });
                setShowAddForm(false);
                fetchGuests();
              }
            } catch (error) {
              console.error('Error adding guest:', error);
            }
          };

          const updateGuest = async () => {
            if (!editingGuest) return;
            
            try {
              const response = await fetch(`${API_URL}/api/guests/${editingGuest.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(editingGuest)
              });
              
              if (response.ok) {
                setEditingGuest(null);
                fetchGuests();
              }
            } catch (error) {
              console.error('Error updating guest:', error);
            }
          };

          const deleteGuest = async (id) => {
            try {
              await fetch(`${API_URL}/api/guests/${id}`, { method: 'DELETE' });
              fetchGuests();
            } catch (error) {
              console.error('Error deleting guest:', error);
            }
          };

          const autoAssignCars = async () => {
            try {
              await fetch(`${API_URL}/api/assign-cars`, { method: 'POST' });
              fetchGuests();
            } catch (error) {
              console.error('Error assigning cars:', error);
            }
          };

          const handleBulkUpload = async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
              const response = await fetch(`${API_URL}/api/bulk-upload`, {
                method: 'POST',
                body: formData
              });
              
              if (response.ok) {
                fetchGuests();
              }
            } catch (error) {
              console.error('Error uploading file:', error);
            }
          };

          const stats = {
            total: guests.length,
            onTime: guests.filter(g => g.status === 'On Time').length,
            delayed: guests.filter(g => g.status === 'Delayed').length,
            cancelled: guests.filter(g => g.status === 'Cancelled').length,
            landed: guests.filter(g => g.status === 'Landed').length,
            cars: new Set(guests.filter(g => g.car_assigned).map(g => g.car_assigned)).size
          };

          const filteredGuests = guests.filter(g => {
            const matchesSearch = g.name?.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                 g.flight?.toLowerCase().includes(searchTerm.toLowerCase());
            const matchesStatus = statusFilter === 'all' || g.status === statusFilter;
            return matchesSearch && matchesStatus;
          });

          const groupedByFlight = filteredGuests.reduce((acc, guest) => {
            const key = guest.flight;
            if (!acc[key]) acc[key] = [];
            acc[key].push(guest);
            return acc;
          }, {});

          return (
            <div className="min-h-screen bg-gray-50 p-6">
              <div className="max-w-7xl mx-auto">
                {/* Header */}
                <div className="mb-8">
                  <h1 className="text-4xl font-bold text-gray-900 mb-2">Airport Pickup Manager</h1>
                  <p className="text-gray-600">Real-time flight tracking powered by AviationStack API</p>
                  <p className="text-sm text-gray-500 mt-1">Last updated: {lastUpdated}</p>
                </div>

                {/* Stats Cards */}
                <div className="grid grid-cols-6 gap-4 mb-6">
                  <div className="bg-white border-l-4 border-blue-500 p-4 rounded-lg shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Total</p>
                        <p className="text-3xl font-bold text-gray-900">{stats.total}</p>
                      </div>
                      <Users className="w-8 h-8 text-blue-500" />
                    </div>
                  </div>

                  <div className="bg-white border-l-4 border-green-500 p-4 rounded-lg shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">On Time</p>
                        <p className="text-3xl font-bold text-gray-900">{stats.onTime}</p>
                      </div>
                      <CheckCircle className="w-8 h-8 text-green-500" />
                    </div>
                  </div>

                  <div className="bg-white border-l-4 border-yellow-500 p-4 rounded-lg shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Delayed</p>
                        <p className="text-3xl font-bold text-gray-900">{stats.delayed}</p>
                      </div>
                      <Clock className="w-8 h-8 text-yellow-500" />
                    </div>
                  </div>

                  <div className="bg-white border-l-4 border-red-500 p-4 rounded-lg shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Cancelled</p>
                        <p className="text-3xl font-bold text-gray-900">{stats.cancelled}</p>
                      </div>
                      <XCircle className="w-8 h-8 text-red-500" />
                    </div>
                  </div>

                  <div className="bg-white border-l-4 border-blue-600 p-4 rounded-lg shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Landed</p>
                        <p className="text-3xl font-bold text-gray-900">{stats.landed}</p>
                      </div>
                      <Plane className="w-8 h-8 text-blue-600" />
                    </div>
                  </div>

                  <div className="bg-white border-l-4 border-purple-500 p-4 rounded-lg shadow-sm">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm text-gray-600">Cars</p>
                        <p className="text-3xl font-bold text-gray-900">{stats.cars}</p>
                      </div>
                      <Car className="w-8 h-8 text-purple-500" />
                    </div>
                  </div>
                </div>

                {/* Controls */}
                <div className="bg-white rounded-lg shadow-sm p-4 mb-6">
                  <div className="flex items-center gap-4">
                    <input
                      type="text"
                      placeholder="Search by name or flight number..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    
                    <select
                      value={statusFilter}
                      onChange={(e) => setStatusFilter(e.target.value)}
                      className="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="all">All Statuses</option>
                      <option value="On Time">On Time</option>
                      <option value="Delayed">Delayed</option>
                      <option value="Cancelled">Cancelled</option>
                      <option value="Landed">Landed</option>
                    </select>

                    <button
                      onClick={() => setShowAddForm(!showAddForm)}
                      className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                    >
                      <Plus className="w-4 h-4" />
                      Add Guest
                    </button>

                    <label className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition cursor-pointer">
                      <Upload className="w-4 h-4" />
                      Bulk Upload
                      <input type="file" accept=".csv,.xlsx" onChange={handleBulkUpload} className="hidden" />
                    </label>

                    <button
                      onClick={fetchGuests}
                      disabled={loading}
                      className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition disabled:opacity-50"
                    >
                      <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                      Refresh
                    </button>

                    <button
                      onClick={autoAssignCars}
                      className="flex items-center gap-2 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition"
                    >
                      <Shuffle className="w-4 h-4" />
                      Auto Assign
                    </button>
                  </div>
                </div>

                {/* Add Guest Form */}
                {showAddForm && (
                  <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 className="text-lg font-semibold mb-4">Add New Guest</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <input
                        type="text"
                        placeholder="Name"
                        value={newGuest.name}
                        onChange={(e) => setNewGuest({...newGuest, name: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg"
                      />
                      <input
                        type="tel"
                        placeholder="Phone Number"
                        value={newGuest.phone}
                        onChange={(e) => setNewGuest({...newGuest, phone: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg"
                      />
                      <input
                        type="text"
                        placeholder="Flight Number"
                        value={newGuest.flight}
                        onChange={(e) => setNewGuest({...newGuest, flight: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg"
                      />
                      <select
                        value={newGuest.airline}
                        onChange={(e) => setNewGuest({...newGuest, airline: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg"
                      >
                        <option value="">Select Airline</option>
                        {airlines.map(a => (
                          <option key={a.code} value={a.code}>{a.name}</option>
                        ))}
                      </select>
                      <input
                        type="text"
                        placeholder="Origin (e.g., DCA)"
                        value={newGuest.origin}
                        onChange={(e) => setNewGuest({...newGuest, origin: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg"
                      />
                      <input
                        type="text"
                        placeholder="Destination (e.g., IAH)"
                        value={newGuest.destination}
                        onChange={(e) => setNewGuest({...newGuest, destination: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg"
                      />
                      <input
                        type="date"
                        value={newGuest.date}
                        onChange={(e) => setNewGuest({...newGuest, date: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg"
                      />
                      <input
                        type="time"
                        value={newGuest.time}
                        onChange={(e) => setNewGuest({...newGuest, time: e.target.value})}
                        className="px-4 py-2 border border-gray-300 rounded-lg"
                      />
                    </div>
                    <div className="flex gap-3 mt-4">
                      <button
                        onClick={addGuest}
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                      >
                        Add Guest
                      </button>
                      <button
                        onClick={() => setShowAddForm(false)}
                        className="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400"
                      >
                        Cancel
                      </button>
                    </div>
                  </div>
                )}

                {/* Flights Dashboard */}
                <div className="mb-4">
                  <h2 className="text-2xl font-bold text-gray-900">Flights Dashboard</h2>
                </div>

                <div className="space-y-4">
                  {Object.entries(groupedByFlight).map(([flight, flightGuests]) => {
                    const firstGuest = flightGuests[0];
                    const statusColor = 
                      firstGuest.status === 'On Time' ? 'bg-green-50 border-green-200' :
                      firstGuest.status === 'Delayed' ? 'bg-yellow-50 border-yellow-200' :
                      firstGuest.status === 'Cancelled' ? 'bg-red-50 border-red-200' :
                      'bg-blue-50 border-blue-200';

                    return (
                      <div key={flight} className={`${statusColor} border-2 rounded-lg p-6`}>
                        <div className="flex items-start justify-between mb-4">
                          <div className="flex items-center gap-3">
                            <Plane className="w-6 h-6" />
                            <div>
                              <h3 className="text-2xl font-bold">{flight}</h3>
                              <p className="text-gray-600">
                                {firstGuest.airline} • From {firstGuest.origin}
                                {firstGuest.destination && ` to ${firstGuest.destination}`}
                              </p>
                              <p className="text-sm text-gray-500">
                                {new Date(firstGuest.eta).toLocaleString('en-US', {
                                  month: '2-digit',
                                  day: '2-digit',
                                  year: 'numeric',
                                  hour: '2-digit',
                                  minute: '2-digit',
                                  hour12: true
                                })}
                              </p>
                            </div>
                          </div>
                          
                          <div className="flex items-center gap-2">
                            {firstGuest.status === 'On Time' && <CheckCircle className="w-5 h-5 text-green-600" />}
                            {firstGuest.status === 'Delayed' && <Clock className="w-5 h-5 text-yellow-600" />}
                            {firstGuest.status === 'Cancelled' && <XCircle className="w-5 h-5 text-red-600" />}
                            {firstGuest.status === 'Landed' && <Plane className="w-5 h-5 text-blue-600" />}
                            <span className="font-semibold">{firstGuest.status}</span>
                          </div>

                          <div className="text-right">
                            <p className="text-2xl font-bold">{flightGuests.length} guests</p>
                          </div>
                        </div>

                        <div className="space-y-2">
                          {flightGuests.map(guest => (
                            <div key={guest.id} className="bg-white rounded-lg p-3">
                              {editingGuest?.id === guest.id ? (
                                <div className="space-y-2">
                                  <input
                                    type="text"
                                    value={editingGuest.name}
                                    onChange={(e) => setEditingGuest({...editingGuest, name: e.target.value})}
                                    className="w-full px-3 py-2 border rounded-lg"
                                  />
                                  <input
                                    type="tel"
                                    value={editingGuest.phone || ''}
                                    onChange={(e) => setEditingGuest({...editingGuest, phone: e.target.value})}
                                    placeholder="Phone Number"
                                    className="w-full px-3 py-2 border rounded-lg"
                                  />
                                  <div className="flex gap-2">
                                    <button
                                      onClick={updateGuest}
                                      className="px-4 py-2 bg-green-600 text-white rounded-lg"
                                    >
                                      Save
                                    </button>
                                    <button
                                      onClick={() => setEditingGuest(null)}
                                      className="px-4 py-2 bg-gray-400 text-white rounded-lg"
                                    >
                                      Cancel
                                    </button>
                                  </div>
                                </div>
                              ) : (
                                <div className="flex items-center justify-between">
                                  <div>
                                    <p className="font-semibold text-gray-900">{guest.name}</p>
                                    {guest.phone && (
                                      <p className="text-sm text-gray-600">📱 {guest.phone}</p>
                                    )}
                                    <p className="text-sm text-gray-600">
                                      {guest.car_assigned ? `Car #${guest.car_assigned}` : 'No car'}
                                    </p>
                                  </div>
                                  <div className="flex gap-2">
                                    <button
                                      onClick={() => setEditingGuest(guest)}
                                      className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg"
                                    >
                                      ✏️
                                    </button>
                                    <button
                                      onClick={() => deleteGuest(guest.id)}
                                      className="p-2 text-red-600 hover:bg-red-50 rounded-lg"
                                    >
                                      🗑️
                                    </button>
                                  </div>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}

                  {Object.keys(groupedByFlight).length === 0 && (
                    <div className="text-center py-12 text-gray-500">
                      No guests found. Click "Add Guest" or "Bulk Upload" to get started!
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<AirportPickupManager />, document.getElementById('root'));
    </script>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script>
        lucide.createIcons();
    </script>
</body>
</html>
